# LSM

## 经典的LSM实现-LevelDB

适合磁盘读写的索引操作有两种，一种就地更新的（B+ tree），一种就是非就地更新的（LSM）

在就地更新的索引结构拥有很好的读性能（随机读与顺序读），而随机写的性能就比较差，无法满足现实工业中的工作负载要求（比如大量日志写入）。



如何优化这部分性能？我们将随机写变成**顺序写入**，通过日志仅追加的模式进行写



## 顺序写入问题



顺序写入的操作时间复杂度为O(1)，但是会出现一个key会被写入多次，这样就带来了一些问题：

1. 读取性能低，一个key被多次写入的话，如果要找出他的话，需要从头到尾遍历一次文件，从而避免重复的key的干扰
2. 数据没有排序，没有范围查找的操作
3. 文件一直在追加读写，会造成文件无限大从而，查询性能降低

## 优化点

合并这个无限大的文件，将被从福德key清理掉，只保留最新的key（类似于GC）

由于在同一个打文件中，不能一边压缩，一边更新，所以需要将文件分段

同时为了保证文件有序，能进行范围查找，需要将文件进行合并（用归并排序的思想）。

为了降低读取的复杂度，需要利用内存，将最新写入的KV存储在内存数据结构中。

但是还是需要读全部，所以我们需要进行分层设计。

进行了分层还不够，还需要对这个文件进行磁盘索引机制sstable。

为了标记文件在文件在哪一层，需要一个sstable的元数据管理文件，叫做manifest文件。

作为一个db需要保证数据一致性，所以还需要一个预写日志。



# 参考

[程序员需要知道的SSD基本原理 | Charles的技术博客 (oserror.com)](http://oserror.com/backend/ssd-principle/)